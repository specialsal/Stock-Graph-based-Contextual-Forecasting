# Stock Graph-based Contextual Forecasting 工程架构文档

## 项目概述

这是一个基于图神经网络和上下文特征的股票预测系统，采用滚动训练和回测框架，实现周频的股票排序预测。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Stock Graph-based Contextual Forecasting         │
├─────────────────────────────────────────────────────────────────────────┤
│                           数据获取层 (Data Acquisition)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   聚宽数据   │  │   AKShare   │  │   交易日历   │  │   股票信息   │    │
│  │   RQData    │  │   数据源    │  │   日历数据   │  │   基础数据   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
├─────────────────────────────────────────────────────────────────────────┤
│                           特征工程层 (Feature Engineering)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  技术指标    │  │  量价特征   │  │  波动特征    │  │  动量特征    │    │
│  │ 技术分析    │  │ 成交特征    │  │ 风险特征     │  │ 趋势特征     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
├─────────────────────────────────────────────────────────────────────────┤
│                           上下文特征层 (Context Features)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  市场指数    │  │  风格板块   │  │  行业特征   │  │  宏观环境   │    │
│  │ 指数特征    │  │ 风格特征    │  │ 行业轮动    │  │ 市场情绪     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
├─────────────────────────────────────────────────────────────────────────┤
│                           模型层 (Model Architecture)                   │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    GCFNet (Graph Context Fusion Network)         │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │    │
│  │  │ 日频编码器   │  │ 图神经网络  │  │  FiLM融合   │  │ 输出层  │ │    │
│  │  │ DailyEncoder│  │ DynamicGraph│  │ ContextGate│  │ Ranking │ │    │
│  │  │    (CNN)    │  │   (GAT)     │  │   (FiLM)    │  │  Head   │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │    │
│  └─────────────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────────────┤
│                           训练层 (Training Framework)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 滚动训练    │  │ Pairwise    │  │  早停机制   │  │ 模型保存    │    │
│  │ RollingTrain│  │ RankNet     │  │ EarlyStop   │  │ ModelSave   │    │
│  │             │  │ 损失函数    │  │             │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
├─────────────────────────────────────────────────────────────────────────┤
│                           回测层 (Backtesting Framework)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 预测生成    │  │ 持仓优化    │  │ 绩效评估    │  │ 组合分析    │    │
│  │ Prediction  │  │ Position   │  │ Metrics     │  │ Portfolio   │    │
│  │ Generation  │  │ Optimization│  │ Evaluation  │  │ Analysis    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心模块功能详解

### 1. 数据获取层 (Data Acquisition)

**文件**: `data_acquire.py`

**功能**:
- 从聚宽(RQData)和AKShare获取原始数据
- 增量更新机制，避免重复下载
- 支持多种数据源：股票价格、指数、行业、停牌信息等

**数据源**:
- 股票日行情数据 (stock_price_day.parquet)
- 指数日行情数据 (index_price_day.parquet) 
- 风格板块数据 (sector_price_day.parquet)
- 交易日历数据 (trading_day.csv)
- 股票基础信息 (stock_info.csv)

### 2. 特征工程层 (Feature Engineering)

**文件**: `feature_engineering.py`

**功能**:
- 生成技术指标特征（RSI、MACD、布林带等）
- 量价特征（成交量、换手率等）
- 波动特征（ATR、标准差等）
- 动量特征（不同周期的收益率）
- 增量计算，只处理缺失的周五数据

**特征类型**:
- 技术指标: RSI, MACD, 布林带, ATR等
- 量价特征: 成交量、换手率、价格成交量相关性
- 动量特征: 5/10/20/30/60日动量
- 形态特征: K线形态、均线交叉等

### 3. 上下文特征层 (Context Features)

**文件**: `feature_context.py`

**功能**:
- 市场指数特征（沪深300、中证500、中证1000）
- 风格板块特征（周期、成长、消费、稳定、金融）
- 市场广度指标
- 为模型提供宏观市场环境信息

### 4. 标签生成层 (Label Generation)

**文件**: `label_generation.py`

**功能**:
- 生成周频的股票排序标签
- 基于未来收益率的排名标签
- 支持多空标签生成

### 5. 模型架构层 (Model Architecture)

**文件**: `model.py`

**核心模型**: GCFNet (Graph Context Fusion Network)

**组件**:
- **DailyEncoder**: 日频特征编码器，使用CNN提取时间序列特征
- **DynamicGraphBlock**: 动态图神经网络，基于行业关系构建图结构
- **FiLM**: 特征线性调制，融合上下文特征
- **Ranking Head**: 排序输出层，生成股票排序分数

**图结构**:
- 节点: 股票
- 边: 基于行业分类的关系
- 图类型: GAT (Graph Attention Network)

### 6. 训练框架层 (Training Framework)

**文件**: `train_rolling.py`, `train_utils.py`

**核心特性**:
- **滚动训练**: 5年训练 + 1年验证的滚动窗口
- **Pairwise RankNet**: 成对排序损失函数，带margin
- **早停机制**: 基于验证集RankIC的早停
- **RAM加速**: 窗口级数据预加载到内存
- **混合精度训练**: 支持FP16/BF16加速

**损失函数**:
```python
def pairwise_ranking_loss_margin(scores, labels, margin=0.0025):
    # Pairwise RankNet with constant margin
    # 最大化高收益股票与低收益股票的分数差异
```

### 7. 回测框架层 (Backtesting Framework)

**文件**: `backtest_rolling.py`, `btr_backtest.py`, `btr_metrics.py`

**回测流程**:
1. **预测生成**: 使用训练好的模型生成股票打分
2. **持仓优化**: 基于打分进行多空组合构建
3. **绩效评估**: 计算各种风险收益指标
4. **组合分析**: 支持黄金ETF等组合策略

**关键指标**:
- RankIC: 排序信息系数
- 年化收益率、夏普比率、最大回撤
- 换手率、胜率等交易指标

## 数据流图

```
原始数据 → 特征工程 → 上下文特征 → 标签生成
    ↓        ↓          ↓           ↓
数据存储 → 特征存储 → 上下文存储 → 标签存储
    ↓        ↓          ↓           ↓
          ┌─────────────────────┐
          │   滚动训练框架        │
          │  (train_rolling.py)  │
          └─────────────────────┘
                    ↓
          ┌─────────────────────┐
          │    模型推理与回测     │
          │ (backtest_rolling.py)│
          └─────────────────────┘
                    ↓
          ┌─────────────────────┐
          │    绩效评估与报告     │
          │   (btr_metrics.py)   │
          └─────────────────────┘
```

## 依赖关系图

### 核心依赖
```
config.py (全局配置)
    ↓
utils.py (通用工具函数)
    ↓
┌─────────────────┬─────────────────┬─────────────────┐
│ data_acquire.py │feature_engineering.py│feature_context.py│
└─────────────────┴─────────────────┴─────────────────┘
    ↓               ↓                   ↓
┌─────────────────────────────────────────────────────┐
│               run_pipeline.py (主流程)                 │
└─────────────────────────────────────────────────────┘
    ↓
┌─────────────────┬─────────────────┬─────────────────┐
│ train_rolling.py │  model.py      │ train_utils.py  │
└─────────────────┴─────────────────┴─────────────────┘
    ↓
┌─────────────────┬─────────────────┬─────────────────┐
│backtest_rolling.py│ btr_backtest.py │ btr_metrics.py │
└─────────────────┴─────────────────┴─────────────────┘
```

### 工具模块依赖
- `utils.py`: 数据加载、日历处理、指标计算
- `utils_backtest.py`: 回测指标计算、最大回撤分析
- `optim_l2qp.py`: L2正则化二次规划优化器
- `optimize_position.py`: 持仓优化算法

## 配置文件结构

**文件**: `config.py`

**主要配置项**:
- 数据路径配置
- 模型超参数（隐藏层大小、学习率等）
- 训练参数（批次大小、早停策略等）
- 回测参数（持仓比例、成本设置等）
- Pairwise RankNet参数（margin值、成对数量）

## 运行流程

### 完整流程 (run_pipeline.py)
```python
1. 数据获取 (data_acquire.py)
2. 特征工程 (feature_engineering.py) 
3. 上下文特征 (feature_context.py)
4. 标签生成 (label_generation.py)
5. 滚动训练 (train_rolling.py)
6. 回测生成 (backtest_rolling.py)
7. 持仓优化 (btr_backtest.py)
8. 绩效评估 (btr_metrics.py)
```

### 增量更新流程
系统支持增量更新，只处理新增的数据日期，避免重复计算。

## 技术特色

1. **图神经网络**: 利用行业关系构建股票图结构
2. **上下文融合**: 通过FiLM机制融合市场宏观特征
3. **滚动训练**: 模拟真实投资中的模型更新过程
4. **Pairwise排序**: 使用成对排序损失优化排名性能
5. **增量计算**: 高效的数据处理和特征更新机制
6. **RAM加速**: 内存预加载大幅提升训练速度

## 性能优化

- **混合精度训练**: 支持FP16/BF16加速
- **并行计算**: 多线程特征计算
- **内存管理**: 智能的数据加载和缓存策略
- **增量更新**: 避免重复计算，提升效率

这个架构设计体现了现代量化投资系统的典型特征：数据驱动、模型复杂、流程自动化、性能优化。